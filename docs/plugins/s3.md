# S3 Plugin

AWS S3 implementation for cloud storage and CDN integration in the Token Ring AI ecosystem.

## Overview

The `@tokenring-ai/s3` package provides comprehensive AWS S3 integration for the Token Ring AI system. It implements both CDN (Content Delivery Network) and File System providers for seamless cloud storage and content delivery. The package integrates with the Token Ring application framework through plugin architecture and supports configuration-based provider registration.

### Key Features

- **CDN Provider**: S3-based Content Delivery Network integration with configurable providers
- **File System Provider**: S3-backed file system implementation with full CRUD operations
- **Configuration-driven**: Providers registered automatically from application configuration
- **Service Integration**: Seamless integration with Token Ring's CDN and FileSystemService
- **Type-safe Configuration**: Zod schemas for validation and type safety
- **Plugin Architecture**: Automatic service registration through TokenRingApp

## Providers

The package implements two main provider types:

### S3CDNProvider

AWS S3 integration for CDN services, providing content delivery capabilities.

**Configuration Schema:** `S3CDNProviderOptionsSchema`
- `region`: AWS region (e.g., 'us-east-1')
- `bucket`: S3 bucket name
- `accessKeyId`: AWS access key ID
- `secretAccessKey`: AWS secret access key
- `endpoint?`: Optional custom endpoint

### S3FileSystemProvider

S3-backed file system provider with complete file operations.

**Configuration Schema:** `S3FileSystemProviderOptionsSchema`
- `region`: AWS region (e.g., 'us-east-1')
- `bucket`: S3 bucket name
- `accessKeyId`: AWS access key ID
- `secretAccessKey`: AWS secret access key
- `endpoint?`: Optional custom endpoint

## Core Components

### CDN Integration

The S3CDNProvider registers with the CDNService and provides:

```typescript
interface S3CDNProvider {
  upload(content: Buffer | string, path: string, options?: { mimeType?: string }): Promise<string>;
  // Uploads content to S3 and returns the CDN URL
  
  getUrl(path: string): string;
  // Gets the public URL for S3 content
  
  delete(path: string): Promise<void>;
  // Deletes content from S3 bucket
}
```

### File System Integration

The S3FileSystemProvider registers with FileSystemService and provides:

```typescript
interface S3FileSystemProvider {
  readFile(path: string): Promise<string>;
  // Reads file content from S3
  
  writeFile(path: string, content: string): Promise<void>;
  // Writes file content to S3
  
  deleteFile(path: string): Promise<void>;
  // Deletes file from S3
  
  listFiles(directory: string): Promise<string[]>;
  // Lists files in S3 directory
  
  fileExists(path: string): Promise<boolean>;
  // Checks if file exists in S3
}
```

## Usage Examples

### Configuration-driven Integration

The plugin automatically registers providers based on application configuration:

```typescript
// In your Token Ring application configuration
{
  cdn: {
    providers: {
      s3-public: {
        type: "s3",
        region: "us-east-1",
        bucket: "your-public-bucket",
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
      }
    }
  },
  filesystem: {
    providers: {
      s3-data: {
        type: "s3",
        region: "us-east-1", 
        bucket: "your-data-bucket",
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
      }
    }
  }
}
```

### Programmatic Provider Registration

```typescript
import { TokenRingApp } from '@tokenring-ai/app';
import { CDNService } from '@tokenring-ai/cdn';
import { FileSystemService } from '@tokenring-ai/filesystem';
import { S3CDNProvider, S3FileSystemProvider } from '@tokenring-ai/s3';

const app = new TokenRingApp();

// Register CDN provider
const cdnService = app.requireServiceByType(CDNService);
cdnService.registerProvider('s3-cdn', new S3CDNProvider({
  region: 'us-east-1',
  bucket: 'my-cdn-bucket',
  accessKeyId: 'your-access-key',
  secretAccessKey: 'your-secret-key'
}));

// Register File System provider  
const fileSystemService = app.requireServiceByType(FileSystemService);
fileSystemService.registerFileSystemProvider('s3-fs', new S3FileSystemProvider({
  region: 'us-east-1',
  bucket: 'my-data-bucket',
  accessKeyId: 'your-access-key',
  secretAccessKey: 'your-secret-key'
}));
```

### Using CDN Service

```typescript
import { CDNService } from '@tokenring-ai/cdn';

const cdnService = app.requireServiceByType(CDNService);
const s3Provider = cdnService.getResource('s3-public');

// Upload content
const url = await s3Provider.upload('Hello from S3!', 'welcome.txt', {
  mimeType: 'text/plain'
});

// Get URL
const fileUrl = s3Provider.getUrl('welcome.txt');
console.log('File available at:', fileUrl);
```

### Using File System Service

```typescript
import { FileSystemService } from '@tokenring-ai/filesystem';

const fileSystemService = app.requireServiceByType(FileSystemService);
const s3Fs = fileSystemService.getFileSystem('s3-data');

// Write file
await s3Fs.writeFile('documents/README.md', '# My Documents');

// Read file
const content = await s3Fs.readFile('documents/README.md');
console.log(content);

// List files
const files = await s3Fs.listFiles('documents');
console.log('Documents:', files);

// Check file existence
const exists = await s3Fs.fileExists('documents/README.md');
console.log('File exists:', exists);
```

## Configuration Options

### CDN Configuration

```typescript
interface S3CDNProviderOptions {
  region: string;           // AWS region (e.g., 'us-east-1')
  bucket: string;           // S3 bucket name
  accessKeyId: string;      // AWS access key ID
  secretAccessKey: string;  // AWS secret access key
  endpoint?: string;        // Optional custom endpoint
}

interface CDNConfig {
  providers: {
    [providerName: string]: {
      type: 's3';
      region: string;
      bucket: string;
      accessKeyId: string;
      secretAccessKey: string;
      endpoint?: string;
    };
  };
}
```

### File System Configuration

```typescript
interface S3FileSystemProviderOptions {
  region: string;           // AWS region (e.g., 'us-east-1')
  bucket: string;           // S3 bucket name
  accessKeyId: string;      // AWS access key ID
  secretAccessKey: string;  // AWS secret access key
  endpoint?: string;        // Optional custom endpoint
}

interface FilesystemConfig {
  providers: {
    [providerName: string]: {
      type: 's3';
      region: string;
      bucket: string;
      accessKeyId: string;
      secretAccessKey: string;
      endpoint?: string;
    };
  };
}
```

## Integration with Token Ring Ecosystem

### Plugin Integration

The S3 plugin automatically integrates with Token Ring applications:

```typescript
export default {
  name: '@tokenring-ai/s3',
  version: '0.2.0',
  install(app: TokenRingApp) {
    // CDN provider registration
    const cdnConfig = app.getConfigSlice('cdn', CDNConfigSchema);
    if (cdnConfig) {
      app.waitForService(CDNService, cdnService => {
        for (const name in cdnConfig.providers) {
          const provider = cdnConfig.providers[name];
          if (provider.type === 's3') {
            cdnService.registerProvider(name, new S3CDNProvider(S3CDNProviderOptionsSchema.parse(provider)));
          }
        }
      });
    }

    // Filesystem provider registration
    const filesystemConfig = app.getConfigSlice('filesystem', FileSystemConfigSchema);
    if (filesystemConfig) {
      app.waitForService(FileSystemService, fileSystemService => {
        for (const name in filesystemConfig.providers) {
          const provider = filesystemConfig.providers[name];
          if (provider.type === 's3') {
            fileSystemService.registerFileSystemProvider(name, new S3FileSystemProvider(S3FileSystemProviderOptionsSchema.parse(provider)));
          }
        }
      });
    }
  },
}
```

### Service Dependencies

The S3 plugin requires these services to be available:

1. **CDNService**: For CDN provider registration and management
2. **FileSystemService**: For file system provider registration
3. **TokenRingApp**: For configuration access and service coordination

### Environment Variables

Ensure these environment variables are set:

```bash
export AWS_ACCESS_KEY_ID='your-access-key-id'
export AWS_SECRET_ACCESS_KEY='your-secret-access-key'
export AWS_REGION='us-east-1'  # Optional, can be configured per provider
```

## API Reference

### S3CDNProvider Methods

#### `upload(content, path, options?)`

Uploads content to S3 bucket.

**Parameters:**
- `content`: `Buffer | string` - Content to upload
- `path`: `string` - Destination path in S3 bucket
- `options`: `object` (optional) - Upload options
  - `mimeType`: `string` - MIME type of content

**Returns:** `Promise<string>` - Public URL of uploaded content

#### `getUrl(path)`

Gets the public URL for S3 content.

**Parameters:**
- `path`: `string` - Path of content in S3 bucket

**Returns:** `string` - Public URL

#### `delete(path)`

Deletes content from S3 bucket.

**Parameters:**
- `path`: `string` - Path of content to delete

**Returns:** `Promise<void>`

### S3FileSystemProvider Methods

#### `readFile(path)`

Reads file content from S3.

**Parameters:**
- `path`: `string` - Path of file to read

**Returns:** `Promise<string>` - File content

#### `writeFile(path, content)`

Writes file content to S3.

**Parameters:**
- `path`: `string` - Destination path
- `content`: `string` - Content to write

**Returns:** `Promise<void>`

#### `deleteFile(path)`

Deletes file from S3.

**Parameters:**
- `path`: `string` - Path of file to delete

**Returns:** `Promise<void>`

#### `listFiles(directory)`

Lists files in S3 directory.

**Parameters:**
- `directory`: `string` - Directory path to list

**Returns:** `Promise<string[]>` - Array of file paths

#### `fileExists(path)`

Checks if file exists in S3.

**Parameters:**
- `path`: `string` - Path to check

**Returns:** `Promise<boolean>` - True if file exists

## Package Structure

```
pkg/s3/
├── plugin.ts          # Plugin integration logic
├── package.json      # Package configuration and dependencies
├── S3CDNProvider.ts  # CDN provider implementation
└── S3FileSystemProvider.ts # File system provider implementation
```

## Dependencies

```json
{
  "dependencies": {
    "@tokenring-ai/app": "0.2.0",
    "@aws-sdk/client-s3": "^3.952.0",
    "zod": "catalog:"
  },
  "peerDependencies": {
    "@tokenring-ai/cdn": "0.2.0",
    "@tokenring-ai/filesystem": "0.2.0"
  },
  "devDependencies": {
    "vitest": "catalog:",
    "typescript": "catalog:"
  }
}
```

## Testing

The package includes Vitest configuration for testing:

```typescript
// vitest.config.ts
import {defineConfig} from "vitest/config";

export default defineConfig({
  test: {
    include: ["**/*.test.ts"],
    environment: "node", 
    globals: true,
    isolate: true,
  },
});
```

## Error Handling

The S3 plugin provides comprehensive error handling:

1. **Configuration Validation**: Zod schemas validate all configuration inputs
2. **Service Dependencies**: Graceful handling when required services aren't available
3. **AWS API Errors**: Proper error handling for S3 API failures
4. **Permission Errors**: Handling of permission and access errors
5. **Network Errors**: Proper handling of network connectivity issues

## Performance Considerations

- **Connection Pooling**: AWS SDK handles connection pooling
- **Region Optimization**: Uses specified AWS region for optimal performance
- **Content Delivery**: Leverages S3's global CDN infrastructure
- **Batch Operations**: Supports batch operations for efficiency
- **Caching**: S3 provides built-in caching and CDN features

## License

MIT (see LICENSE file)